name: Test Start Scripts

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - 'start.sh'
      - 'start.ps1'
      - '.github/workflows/setup-test.yml'
      - 'backend/pyproject.toml'
      - 'backend/poetry.lock'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Test on Ubuntu Linux
  # ============================================
  test-linux:
    name: Test Start - Linux (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run start script
        run: |
          chmod +x start.sh
          ./start.sh --skip-docker --no-start

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test e2e/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on macOS
  # ============================================
  test-macos:
    name: Test Start - macOS
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run start script
        run: |
          chmod +x start.sh
          ./start.sh --skip-docker --no-start

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test e2e/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on Windows (using start.ps1 with embedded runtimes)
  # ============================================
  test-windows:
    name: Test Start - Windows
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # No pre-installation needed - start.ps1 downloads embedded Python and Node.js
      - name: Run start.ps1 script
        shell: pwsh
        run: |
          # Run the actual start.ps1 script with -SkipDocker -NoStart flags
          # The script downloads embedded Python and Node.js to local_venv/
          # -SkipDocker: Docker Desktop cannot be installed on GitHub Actions Windows runners
          # -NoStart: Don't start the servers, just set up dependencies
          powershell -ExecutionPolicy Bypass -File start.ps1 -SkipDocker -NoStart

      - name: Verify embedded runtimes installed
        shell: pwsh
        run: |
          # Check that local_venv directory was created with embedded runtimes
          if (Test-Path "local_venv/python/python.exe") {
            $pyVersion = & "local_venv/python/python.exe" --version
            Write-Host "Embedded Python: $pyVersion - OK"
          } else {
            Write-Host "ERROR: Embedded Python not found"
            exit 1
          }

          if (Test-Path "local_venv/node/node.exe") {
            $nodeVersion = & "local_venv/node/node.exe" --version
            Write-Host "Embedded Node.js: $nodeVersion - OK"
          } else {
            Write-Host "ERROR: Embedded Node.js not found"
            exit 1
          }

          if (Test-Path "local_venv/python/Scripts/poetry.exe") {
            $poetryVersion = & "local_venv/python/Scripts/poetry.exe" --version
            Write-Host "Poetry: $poetryVersion - OK"
          } else {
            Write-Host "ERROR: Poetry not found"
            exit 1
          }

      - name: Verify backend dependencies
        shell: pwsh
        working-directory: backend
        run: |
          $poetry = "${{ github.workspace }}/local_venv/python/Scripts/poetry.exe"
          & $poetry run python -c "import fastapi; print('FastAPI OK')"
          & $poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        shell: pwsh
        working-directory: frontend
        run: |
          $npm = "${{ github.workspace }}/local_venv/node/npm.cmd"
          & $npm list vite
          & $npm list react

      - name: Verify .env file was created
        shell: pwsh
        working-directory: backend
        run: |
          if (Test-Path ".env") {
            Write-Host ".env file exists - OK"
            # Verify it contains the encryption key
            $content = Get-Content ".env" -Raw
            if ($content -match "MASTER_ENCRYPTION_KEY=") {
              Write-Host "MASTER_ENCRYPTION_KEY is set - OK"
            } else {
              Write-Host "ERROR: MASTER_ENCRYPTION_KEY not found in .env"
              exit 1
            }
          } else {
            Write-Host "ERROR: .env file was not created"
            exit 1
          }

      - name: Verify data directory was created
        shell: pwsh
        working-directory: backend
        run: |
          if (Test-Path "data") {
            Write-Host "data directory exists - OK"
          } else {
            Write-Host "ERROR: data directory was not created"
            exit 1
          }

      - name: Verify frontend build works
        shell: pwsh
        working-directory: frontend
        run: |
          $npm = "${{ github.workspace }}/local_venv/node/npm.cmd"
          & $npm run build
          Write-Host "Frontend build successful!"
