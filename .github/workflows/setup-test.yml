name: Test Start Scripts

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Test on Ubuntu Linux
  # ============================================
  test-linux:
    name: Test Start - Linux (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run start script
        run: |
          chmod +x start.sh
          ./start.sh --skip-docker --no-start

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test e2e/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on macOS
  # ============================================
  test-macos:
    name: Test Start - macOS
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run start script
        run: |
          chmod +x start.sh
          ./start.sh --skip-docker --no-start

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test e2e/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on Windows (using start.ps1)
  # ============================================
  test-windows:
    name: Test Start - Windows
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Pre-install Python and Node.js via GitHub Actions (faster than Chocolatey)
      # The script will detect these and skip installation
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run start.ps1 script
        shell: pwsh
        run: |
          # Run the actual start.ps1 script with -SkipDocker -NoStart flags
          # -SkipDocker: Docker Desktop cannot be installed on GitHub Actions Windows runners
          #              (requires GUI, restart, and Hyper-V which aren't available in CI)
          # -NoStart: Don't start the servers, just set up dependencies
          powershell -ExecutionPolicy Bypass -File start.ps1 -SkipDocker -NoStart

      - name: Verify backend dependencies
        shell: pwsh
        working-directory: backend
        run: |
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        shell: pwsh
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Verify .env file was created
        shell: pwsh
        working-directory: backend
        run: |
          if (Test-Path ".env") {
            Write-Host ".env file exists - OK"
            # Verify it contains the encryption key
            $content = Get-Content ".env" -Raw
            if ($content -match "MASTER_ENCRYPTION_KEY=") {
              Write-Host "MASTER_ENCRYPTION_KEY is set - OK"
            } else {
              Write-Host "ERROR: MASTER_ENCRYPTION_KEY not found in .env"
              exit 1
            }
          } else {
            Write-Host "ERROR: .env file was not created"
            exit 1
          }

      - name: Verify data directory was created
        shell: pwsh
        working-directory: backend
        run: |
          if (Test-Path "data") {
            Write-Host "data directory exists - OK"
          } else {
            Write-Host "ERROR: data directory was not created"
            exit 1
          }

      # Note: Skipping server start and Playwright tests on Windows CI
      # Windows GitHub Actions runners have known issues with localhost connections
      # The Linux and macOS tests validate the full server functionality
      - name: Verify frontend build works
        shell: pwsh
        working-directory: frontend
        run: |
          npm run build
          Write-Host "Frontend build successful!"
