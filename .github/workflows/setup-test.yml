name: Test Setup Scripts

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - 'setup.sh'
      - 'setup.ps1'
      - '.github/workflows/setup-test.yml'
      - 'backend/pyproject.toml'
      - 'backend/poetry.lock'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Test on Ubuntu Linux
  # ============================================
  test-linux:
    name: Test Setup - Linux (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          chmod +x setup.sh
          ./setup.sh --skip-docker

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test tests/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on macOS
  # ============================================
  test-macos:
    name: Test Setup - macOS
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          chmod +x setup.sh
          ./setup.sh --skip-docker

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test tests/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on Windows
  # ============================================
  test-windows:
    name: Test Setup - Windows
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Pre-install dependencies for faster CI (skip Chocolatey)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Poetry
        shell: pwsh
        run: |
          (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
          $env:Path += ";$env:APPDATA\Python\Scripts"
          echo "$env:APPDATA\Python\Scripts" >> $env:GITHUB_PATH

      - name: Setup backend
        shell: pwsh
        working-directory: backend
        run: |
          poetry install --with dev

          # Create .env file
          $encryptionKey = poetry run python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
          @"
          DATABASE_URL=sqlite+aiosqlite:///./data/breezerun.db
          HOST=127.0.0.1
          PORT=8000
          CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:5174
          MASTER_ENCRYPTION_KEY=$encryptionKey
          "@ | Set-Content ".env"

          New-Item -ItemType Directory -Path "data" -Force | Out-Null

      - name: Setup frontend
        shell: pwsh
        working-directory: frontend
        run: npm install

      - name: Verify backend dependencies
        shell: pwsh
        working-directory: backend
        run: |
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        shell: pwsh
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        shell: pwsh
        working-directory: backend
        run: |
          # Start backend in background using Start-Process with redirected output
          $backendLog = "$env:TEMP\backend.log"
          Start-Process -FilePath "poetry" -ArgumentList "run", "python", "-m", "app.main" -RedirectStandardOutput $backendLog -RedirectStandardError "$env:TEMP\backend-error.log" -WindowStyle Hidden

          # Wait for server to be ready (up to 90 seconds)
          $maxAttempts = 18
          $attempt = 0
          $started = $false
          while ($attempt -lt $maxAttempts) {
            Start-Sleep -Seconds 5
            $attempt++
            try {
              $response = Invoke-WebRequest -Uri http://localhost:8000/ -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "Backend is ready after $($attempt * 5) seconds"
                $started = $true
                break
              }
            } catch {
              Write-Host "Waiting for backend... attempt $attempt/$maxAttempts"
            }
          }

          if (-not $started) {
            Write-Host "=== Backend stdout ==="
            if (Test-Path $backendLog) { Get-Content $backendLog }
            Write-Host "=== Backend stderr ==="
            if (Test-Path "$env:TEMP\backend-error.log") { Get-Content "$env:TEMP\backend-error.log" }
            exit 1
          }

      - name: Start frontend server
        shell: pwsh
        working-directory: frontend
        run: |
          # Start frontend in background using Start-Process with redirected output
          $frontendLog = "$env:TEMP\frontend.log"
          Start-Process -FilePath "npm" -ArgumentList "run", "dev" -RedirectStandardOutput $frontendLog -RedirectStandardError "$env:TEMP\frontend-error.log" -WindowStyle Hidden

          # Wait for server to be ready (up to 90 seconds)
          $maxAttempts = 18
          $attempt = 0
          $started = $false
          while ($attempt -lt $maxAttempts) {
            Start-Sleep -Seconds 5
            $attempt++
            try {
              $response = Invoke-WebRequest -Uri http://localhost:5173/ -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "Frontend is ready after $($attempt * 5) seconds"
                $started = $true
                break
              }
            } catch {
              Write-Host "Waiting for frontend... attempt $attempt/$maxAttempts"
            }
          }

          if (-not $started) {
            Write-Host "=== Frontend stdout ==="
            if (Test-Path $frontendLog) { Get-Content $frontendLog }
            Write-Host "=== Frontend stderr ==="
            if (Test-Path "$env:TEMP\frontend-error.log") { Get-Content "$env:TEMP\frontend-error.log" }
            exit 1
          }

      - name: Install Playwright
        shell: pwsh
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend with screenshot
        shell: pwsh
        working-directory: frontend
        run: |
          # Create screenshots directory
          New-Item -ItemType Directory -Path "screenshots" -Force | Out-Null

          # Use Playwright to take a screenshot of the landing page
          npx playwright test tests/screenshot.spec.ts --project=chromium || true

          # Fallback: use Playwright directly to take screenshot if test doesn't exist
          if (-not (Test-Path "screenshots/landing-page.png")) {
            node -e "
              const { chromium } = require('playwright');
              (async () => {
                const browser = await chromium.launch();
                const page = await browser.newPage();
                await page.goto('http://localhost:5173/');
                await page.waitForLoadState('networkidle');
                await page.screenshot({ path: 'screenshots/landing-page.png', fullPage: true });
                await browser.close();
                console.log('Screenshot saved to screenshots/landing-page.png');
              })();
            "
          }

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-frontend-screenshot
          path: frontend/screenshots/
          retention-days: 7
